pipeline {
    agent any

    environment {
        TF_DIR = 'terraform'
        AWS_ACCESS_KEY_ID     = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
    }
    parameters { 
        choice(name: 'ENVIRONMENT', choices: ['deploy', 'destroy'], description: 'To deploy or destroy the environment') 
        }
    stages {
        stage('Terraform Init & Apply') {
            when {
                expression { 
                   return params.ENVIRONMENT == 'deploy'
                }
            }
            steps {
                dir("./task_2/${TF_DIR}") {
                    // Init&deploy infrastructre
                    sh '''
                        terraform init -input=false
                        terraform apply -auto-approve
                    '''
                }
            }
        }
        stage('Extract Terraform Outputs') {
            when {
                expression { 
                   return params.ENVIRONMENT == 'deploy'
                }
            }
            steps {
                dir("./task_2/${TF_DIR}") {
                    script {
                        // Get outputs in JSON format
                        def tf_output = sh(script: 'terraform output -json', returnStdout: true).trim()
                        def parsed = readJSON text: tf_output

                        // Extract values
                        def web_ips = parsed.web_server_ips.value
                        def db_endpoint = parsed.db_endpoint.value

                        // Print for visibility
                        echo "Web IPs: ${web_ips}"
                        echo "DB Endpoint: ${db_endpoint}"
                    }
                }
            }
        }
        stage('Terraform Destroy') {
            when {
                expression { 
                   return params.ENVIRONMENT == 'deploy'
                }
            }
            steps {
                dir("./task_2/${TF_DIR}") {
                    // Init&deploy infrastructre
                    sh '''
                        terraform destroy -auto-approve
                    '''
                }
            }
        }
    }

    post {
        failure {
            dir("./task_2/${TF_DIR}") {
                echo "Pipeline failed. Terraform detroy"
                sh '''
                        terraform destroy -auto-approve
                    '''
                }
        }
    }
}


